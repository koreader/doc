<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>KOReader Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>KOReader</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Output_Module">Output Module </a></li>
<li><a href="#Blitter_Module">Blitter Module </a></li>
<li><a href="#Input_Module">Input Module </a></li>
</ul>


<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/Collaborating_with_Git.md.html">Collaborating with Git</a></li>
  <li><a href="../topics/DataStore.md.html">DataStore</a></li>
  <li><a href="../topics/Development_guide.md.html">Development Guide</a></li>
  <li><a href="../topics/Events.md.html">Events</a></li>
  <li><a href="../topics/Hacking.md.html">Hacking</a></li>
  <li><strong>Porting</strong></li>
  <li><a href="../topics/README.md.html">README</a></li>
  <li><a href="../topics/Unit_tests.md.html">Unit Tests</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/android.html">android</a></li>
  <li><a href="../modules/apps.filemanager.filemanagerbookinfo.html">apps.filemanager.filemanagerbookinfo</a></li>
  <li><a href="../modules/apps.filemanager.filemanagerconverter.html">apps.filemanager.filemanagerconverter</a></li>
  <li><a href="../modules/apps.filemanager.filemanagerutil.html">apps.filemanager.filemanagerutil</a></li>
  <li><a href="../modules/apps.filemanager.lib.md.html">apps.filemanager.lib.md</a></li>
  <li><a href="../modules/apps.reader.modules.readerlink.html">apps.reader.modules.readerlink</a></li>
  <li><a href="../modules/apps.reader.modules.readerview.html">apps.reader.modules.readerview</a></li>
  <li><a href="../modules/apps.reader.readerui.html">apps.reader.readerui</a></li>
  <li><a href="../modules/cache.html">cache</a></li>
  <li><a href="../modules/cacheitem.html">cacheitem</a></li>
  <li><a href="../modules/dbg.html">dbg</a></li>
  <li><a href="../modules/depgraph.html">depgraph</a></li>
  <li><a href="../modules/device.generic.device.html">device.generic.device</a></li>
  <li><a href="../modules/device.gesturedetector.html">device.gesturedetector</a></li>
  <li><a href="../modules/device.input.html">device.input</a></li>
  <li><a href="../modules/device.kobo.nickel_conf.html">device.kobo.nickel_conf</a></li>
  <li><a href="../modules/device.wakeupmgr.html">device.wakeupmgr</a></li>
  <li><a href="../modules/dispatcher.html">dispatcher</a></li>
  <li><a href="../modules/docsettings.html">docsettings</a></li>
  <li><a href="../modules/document.doccache.html">document.doccache</a></li>
  <li><a href="../modules/document.documentregistry.html">document.documentregistry</a></li>
  <li><a href="../modules/document.koptinterface.html">document.koptinterface</a></li>
  <li><a href="../modules/dump.html">dump</a></li>
  <li><a href="../modules/ffi.blitbuffer.html">ffi.blitbuffer</a></li>
  <li><a href="../modules/ffi.framebuffer.html">ffi.framebuffer</a></li>
  <li><a href="../modules/ffi.freetype.html">ffi.freetype</a></li>
  <li><a href="../modules/ffi.jpeg.html">ffi.jpeg</a></li>
  <li><a href="../modules/ffi.md5.html">ffi.md5</a></li>
  <li><a href="../modules/ffi.mupdf.html">ffi.mupdf</a></li>
  <li><a href="../modules/ffi.png.html">ffi.png</a></li>
  <li><a href="../modules/ffi.rtc.html">ffi.rtc</a></li>
  <li><a href="../modules/ffi.sdl2_0.html">ffi.sdl2_0</a></li>
  <li><a href="../modules/ffi.utf8proc.html">ffi.utf8proc</a></li>
  <li><a href="../modules/ffi.util.html">ffi.util</a></li>
  <li><a href="../modules/ffi.zipwriter.html">ffi.zipwriter</a></li>
  <li><a href="../modules/ffi.zlib.html">ffi.zlib</a></li>
  <li><a href="../modules/ffi.zstd.html">ffi.zstd</a></li>
  <li><a href="../modules/gettext.html">gettext</a></li>
  <li><a href="../modules/koplugin.HelloWorld.html">koplugin.HelloWorld</a></li>
  <li><a href="../modules/koplugin.QRClipboard.html">koplugin.QRClipboard</a></li>
  <li><a href="../modules/koplugin.autowarmth.html">koplugin.autowarmth</a></li>
  <li><a href="../modules/koplugin.calibre.metadata.html">koplugin.calibre.metadata</a></li>
  <li><a href="../modules/koplugin.coverimage.html">koplugin.coverimage</a></li>
  <li><a href="../modules/koplugin.japanese.html">koplugin.japanese</a></li>
  <li><a href="../modules/koplugin.japanese.deinflector.html">koplugin.japanese.deinflector</a></li>
  <li><a href="../modules/koplugin.wallabag.html">koplugin.wallabag</a></li>
  <li><a href="../modules/languagesupport.html">languagesupport</a></li>
  <li><a href="../modules/logger.html">logger</a></li>
  <li><a href="../modules/luadata.html">luadata</a></li>
  <li><a href="../modules/luasettings.html">luasettings</a></li>
  <li><a href="../modules/optmath.html">optmath</a></li>
  <li><a href="../modules/random.html">random</a></li>
  <li><a href="../modules/socketutil.html">socketutil</a></li>
  <li><a href="../modules/ui.bidi.html">ui.bidi</a></li>
  <li><a href="../modules/ui.data.css_tweaks.html">ui.data.css_tweaks</a></li>
  <li><a href="../modules/ui.data.keyboardlayouts.ko_KR_helper.html">ui.data.keyboardlayouts.ko_KR_helper</a></li>
  <li><a href="../modules/ui.data.optionsutil.html">ui.data.optionsutil</a></li>
  <li><a href="../modules/ui.downloadmgr.html">ui.downloadmgr</a></li>
  <li><a href="../modules/ui.event.html">ui.event</a></li>
  <li><a href="../modules/ui.font.html">ui.font</a></li>
  <li><a href="../modules/ui.geometry.html">ui.geometry</a></li>
  <li><a href="../modules/ui.hook_container.html">ui.hook_container</a></li>
  <li><a href="../modules/ui.menusorter.html">ui.menusorter</a></li>
  <li><a href="../modules/ui.network.wpa_supplicant.html">ui.network.wpa_supplicant</a></li>
  <li><a href="../modules/ui.otamanager.html">ui.otamanager</a></li>
  <li><a href="../modules/ui.plugin.background_task_plugin.html">ui.plugin.background_task_plugin</a></li>
  <li><a href="../modules/ui.plugin.switch_plugin.html">ui.plugin.switch_plugin</a></li>
  <li><a href="../modules/ui.quickstart.html">ui.quickstart</a></li>
  <li><a href="../modules/ui.renderimage.html">ui.renderimage</a></li>
  <li><a href="../modules/ui.rendertext.html">ui.rendertext</a></li>
  <li><a href="../modules/ui.size.html">ui.size</a></li>
  <li><a href="../modules/ui.timeval.html">ui.timeval</a></li>
  <li><a href="../modules/ui.translator.html">ui.translator</a></li>
  <li><a href="../modules/ui.trapper.html">ui.trapper</a></li>
  <li><a href="../modules/ui.uimanager.html">ui.uimanager</a></li>
  <li><a href="../modules/ui.widget.bboxwidget.html">ui.widget.bboxwidget</a></li>
  <li><a href="../modules/ui.widget.button.html">ui.widget.button</a></li>
  <li><a href="../modules/ui.widget.checkbutton.html">ui.widget.checkbutton</a></li>
  <li><a href="../modules/ui.widget.checkmark.html">ui.widget.checkmark</a></li>
  <li><a href="../modules/ui.widget.closebutton.html">ui.widget.closebutton</a></li>
  <li><a href="../modules/ui.widget.confirmbox.html">ui.widget.confirmbox</a></li>
  <li><a href="../modules/ui.widget.container.alphacontainer.html">ui.widget.container.alphacontainer</a></li>
  <li><a href="../modules/ui.widget.container.bottomcontainer.html">ui.widget.container.bottomcontainer</a></li>
  <li><a href="../modules/ui.widget.container.centercontainer.html">ui.widget.container.centercontainer</a></li>
  <li><a href="../modules/ui.widget.container.framecontainer.html">ui.widget.container.framecontainer</a></li>
  <li><a href="../modules/ui.widget.container.inputcontainer.html">ui.widget.container.inputcontainer</a></li>
  <li><a href="../modules/ui.widget.container.leftcontainer.html">ui.widget.container.leftcontainer</a></li>
  <li><a href="../modules/ui.widget.container.movablecontainer.html">ui.widget.container.movablecontainer</a></li>
  <li><a href="../modules/ui.widget.container.rightcontainer.html">ui.widget.container.rightcontainer</a></li>
  <li><a href="../modules/ui.widget.container.scrollablecontainer.html">ui.widget.container.scrollablecontainer</a></li>
  <li><a href="../modules/ui.widget.container.topcontainer.html">ui.widget.container.topcontainer</a></li>
  <li><a href="../modules/ui.widget.container.underlinecontainer.html">ui.widget.container.underlinecontainer</a></li>
  <li><a href="../modules/ui.widget.container.widgetcontainer.html">ui.widget.container.widgetcontainer</a></li>
  <li><a href="../modules/ui.widget.eventlistener.html">ui.widget.eventlistener</a></li>
  <li><a href="../modules/ui.widget.horizontalgroup.html">ui.widget.horizontalgroup</a></li>
  <li><a href="../modules/ui.widget.htmlboxwidget.html">ui.widget.htmlboxwidget</a></li>
  <li><a href="../modules/ui.widget.iconbutton.html">ui.widget.iconbutton</a></li>
  <li><a href="../modules/ui.widget.iconwidget.html">ui.widget.iconwidget</a></li>
  <li><a href="../modules/ui.widget.imageviewer.html">ui.widget.imageviewer</a></li>
  <li><a href="../modules/ui.widget.imagewidget.html">ui.widget.imagewidget</a></li>
  <li><a href="../modules/ui.widget.infomessage.html">ui.widget.infomessage</a></li>
  <li><a href="../modules/ui.widget.inputdialog.html">ui.widget.inputdialog</a></li>
  <li><a href="../modules/ui.widget.keyboardlayoutdialog.html">ui.widget.keyboardlayoutdialog</a></li>
  <li><a href="../modules/ui.widget.keyvaluepage.html">ui.widget.keyvaluepage</a></li>
  <li><a href="../modules/ui.widget.linewidget.html">ui.widget.linewidget</a></li>
  <li><a href="../modules/ui.widget.listview.html">ui.widget.listview</a></li>
  <li><a href="../modules/ui.widget.logindialog.html">ui.widget.logindialog</a></li>
  <li><a href="../modules/ui.widget.menu.html">ui.widget.menu</a></li>
  <li><a href="../modules/ui.widget.multiconfirmbox.html">ui.widget.multiconfirmbox</a></li>
  <li><a href="../modules/ui.widget.networksetting.html">ui.widget.networksetting</a></li>
  <li><a href="../modules/ui.widget.notification.html">ui.widget.notification</a></li>
  <li><a href="../modules/ui.widget.numberpickerwidget.html">ui.widget.numberpickerwidget</a></li>
  <li><a href="../modules/ui.widget.openwithdialog.html">ui.widget.openwithdialog</a></li>
  <li><a href="../modules/ui.widget.overlapgroup.html">ui.widget.overlapgroup</a></li>
  <li><a href="../modules/ui.widget.progresswidget.html">ui.widget.progresswidget</a></li>
  <li><a href="../modules/ui.widget.qrmessage.html">ui.widget.qrmessage</a></li>
  <li><a href="../modules/ui.widget.radiobutton.html">ui.widget.radiobutton</a></li>
  <li><a href="../modules/ui.widget.scrollhtmlwidget.html">ui.widget.scrollhtmlwidget</a></li>
  <li><a href="../modules/ui.widget.scrolltextwidget.html">ui.widget.scrolltextwidget</a></li>
  <li><a href="../modules/ui.widget.textboxwidget.html">ui.widget.textboxwidget</a></li>
  <li><a href="../modules/ui.widget.textviewer.html">ui.widget.textviewer</a></li>
  <li><a href="../modules/ui.widget.textwidget.html">ui.widget.textwidget</a></li>
  <li><a href="../modules/ui.widget.toggleswitch.html">ui.widget.toggleswitch</a></li>
  <li><a href="../modules/ui.widget.touchmenu.html">ui.widget.touchmenu</a></li>
  <li><a href="../modules/ui.widget.trapwidget.html">ui.widget.trapwidget</a></li>
  <li><a href="../modules/ui.widget.verticalgroup.html">ui.widget.verticalgroup</a></li>
  <li><a href="../modules/ui.widget.widget.html">ui.widget.widget</a></li>
  <li><a href="../modules/util.html">util</a></li>
  <li><a href="../modules/version.html">version</a></li>
</ul>

</div>

<div id="content">


<h1>Porting</h1>

<p>This page aims to provide guidance on how to port KOReader to other platforms.</p>

<p>There are mainly two modules that you need to take care of: input and output. <br/>
After you finish these two, KOReader should have no problem running on your platform. <br/>
Feel free to open issues in our issue tracker if you need further help on this topic :)</p>


<p><a name="Output_Module"></a></p>
<h2>Output Module</h2>

<h3>Current mxcfb eInk devices</h3>

<p>KOReader uses the Linux framebuffer to control eInk devices, so the output module for mxcfb (i.e., those based on Freescale/NXP hardware) devices is <a href="https://github.com/koreader/koreader-base/blob/master/ffi/framebuffer_mxcfb.lua"><code>base/ffi/framebuffer_mxcfb.lua</code></a>.</p>

<p>Most common bitdepths are supported, although no devices should actually be using anything other than 8bpp, 16bpp and 32bpp. <br/>
For 8bpp, we assume the grayscale palette is NOT inverted. <br/>
At 32bpp, we generally assume the pixel format is BGRA, and we honor Alpha, despite it being effectively ignored by the display (see Kobos). <br/>
At 16bpp, we assume the pixel format is RGB565.</p>

<p>For obvious performance reasons, we prefer 8bpp, and we will attempt to enforce that on devices which are not natively running at that depth (i.e., <a href="https://github.com/koreader/koreader/blob/d1cd5e7ad4283611c57007b2c2d3dd5f7dab7057/platform/kobo/koreader.sh#L138-L186">on Kobos</a>). <br/>
As explained below, the same considerations should be kept in mind regarding the effective 16c palette of eInk screens. <br/>
When we're in control of the data, we attempt to always use "perfect" in-palette colors (c.f., the <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/blitbuffer.lua#L1881-L1889">COLOR constants</a> in the BlitBuffer module). <br/>
Otherwise, when there'd be signficiant gain in doing so (i.e., when displaying mainly image content), we attempt to make use of <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/blitbuffer.lua#L227-L271">dithering</a>, ideally <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/framebuffer_mxcfb.lua#L412-L423">offloaded to the hardware</a> when supported.</p>

<p>The actual framebuffer content is then refreshed (i.e., displayed) via device-specific ioctls, making the best effort in using device-specific capabilities, whether that be <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/framebuffer_mxcfb.lua#L643-L655">optimized waveform modes</a>, hardware dithering or <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/framebuffer_mxcfb.lua#L253-L256">hardware inversion</a>.</p>

<p>The platform-specific Lua FFI modules for using the mxcfb driver are generated from the <a href="https://github.com/koreader/koreader-base/ffi-cdecl/include">kernel header files</a> using <a href="https://github.com/koreader/ffi-cdecl">ffi-cdecl</a>. <code>ffi-cdecl</code> operates on <a href="https://github.com/koreader/koreader-base/ffi-cdecl/">C files</a> which specify what to export.</p>

<p>To use <code>ffi-cdecl</code> first you need to build the gcc plugin for the platform toolchain, e.g.:</p>
<pre><code> cd ffi-cdecl
 make clean
 PATH=$HOME/x-tools/arm-remarkable-linux-gnueabihf/bin/:$PATH make CHOST=arm-remarkable-linux-gnueabihf CROSS_DIR=$HOME/x-tools/arm-remarkable-linux-gnueabihf/
</code></pre>

<p>Then you can (re)generate the <a href="https://github.com/koreader/koreader-base/ffi">ffi lua files</a>, e.g.</p>
<pre><code> PATH=$HOME/x-tools/arm-remarkable-linux-gnueabihf/bin/:$PATH ./ffi-cdecl arm-remarkable-linux-gnueabihf-gcc ../koreader/base/ffi-cdecl/mxcfb_remarkable_decl.c ../koreader/base/ffi/mxcfb_remarkable_h.lua
</code></pre>


<h3>Legacy einkfb eInk devices</h3>

<p>KOReader uses the Linux framebuffer to control eInk devices, so the output module for legacy einkfb devices is <a href="https://github.com/koreader/koreader-base/blob/master/ffi/framebuffer_einkfb.lua"><code>base/ffi/framebuffer_einkfb.lua</code></a>.</p>

<p>Following are the framebuffers that <code>framebuffer_einkfb.lua</code> currently supports:</p>

<ul>
    <li>4bpp framebuffer (palette is always inverted)</li>
    <li>16c 8bpp framebuffer (inverted grayscale palette)</li>
</ul>

<p>For 4bpp framebuffers, it means every pixel is represented with 4 bits, so we have 2 pixels in 1 byte. <br/>
That also effectively limits the palette to 16 colors. <br/>
The inverted part means that every pixel's color value is flipped (<code>^ 0xFF</code>). <br/>
For example, two pixels <code>0x00</code> and <code>0xF0</code> will be flipped to <code>0xFF</code> and <code>0x0F</code>, before being packed to accomodate the framebuffer's pixel format (here, <a href="https://github.com/NiLuJe/FBInk/blob/4f0230b17c480cdc75dd5497fddf33937781c812/fbink.c#L106-L133">into a single byte</a>).</p>

<p>For 8bpp framebuffers, it means each pixel is instead stored in 1 byte, making addressing much simpler. <br/>
The effective color palette of the display is still limited to 16 shades of gray: it will do a decimating quantization pass on its own on refresh. <br/>
So, while a black pixel will indeed be <code>0x00</code>, any color value &lt; <code>0x11</code> (the next effective shade of gray in the <a href="https://github.com/NiLuJe/FBInk/blob/4f0230b17c480cdc75dd5497fddf33937781c812/fbink_internal.h#L327-L334">palette</a>) will be displayed as pure black, too. <br/>
If the palette is expected to be inverted, then all the bits are flipped in the same way as done on a 4bpp framebuffer. <br/>
In practice, <a href="https://github.com/koreader/koreader-base/blob/a1fc4e43b7cce7a76b13224e145f9bada343d8ea/ffi/framebuffer_linux.lua#L242-L245">this is always the case</a>.</p>

<p>The actual framebuffer content is then refreshed (i.e., displayed) via device-specific ioctls.</p>

<p><a name="Blitter_Module"></a></p>
<h2>Blitter Module</h2>

<p>All the intermediary buffers are handled in a pixel format that matches the output module in use as closely as possible. <br/>
The magic happens in <a href="https://github.com/koreader/koreader-base/blob/master/ffi/blitbuffer.lua"><code>base/ffi/blitbuffer.lua</code></a>, with some help from the <a href="https://github.com/koreader/koreader-base/blob/master/ffi/framebuffer_linux.lua">LinuxFB</a> frontend to the output modules.</p>

<p>Note that on most devices, a <a href="https://github.com/koreader/koreader-base/blob/master/blitbuffer.c">C version</a> is used instead for more consistent performance. <br/>
Which version is more easily readable to a newcomer is up for debate, so, don't hesitate to cross-reference ;). <br/>
Feature-parity should be complete, with the exception of 4bpp support in the C version. <br/>
If you need a bit of guidance, you can also take a look at <a href="https://github.com/NiLuJe/FBInk">FBInk</a>, and/or ping <a href="https://github.com/NiLuJe">@NiLuJe</a> on gitter.</p>

<p><a name="Input_Module"></a></p>
<h2>Input Module</h2>

<p>We have an <a href="https://github.com/koreader/koreader-base/blob/master/input/input.c"><code>input.c</code></a> module in <a href="https://github.com/koreader/koreader-base">koreader-base</a> that reads input events from Linux's input system and passes it on to the Lua frontend. <br/>
Basically, you don't need to change that module because it should support most of the events.</p>

<p>For this part, the file you have to hack on is <a href="https://github.com/koreader/koreader/blob/master/frontend/ui/input.lua"><code>koreader/frontend/ui/input.lua</code></a>.</p>

<p>Firstly, you need to tell which input device to open on KOReader start. All the input devices are opened in <code>Input:init()</code> function.</p>

<p>Next, you might need to define <code>Input:eventAdjustHook()</code> function in <code>Input:init()</code> method. <br/>
We use this hook function to translate events into a format that KOReader understands. <br/>
You can look at the KindleTouch initialization code for a real-world example.</p>

<p>For some Kobo devices (Mini, Touch, Glo and Aura HD) the function <code>Input:eventAdjustHook()</code> was skipped and the functions <code>Input:init()</code> and <code>Input:handleTypeBTouchEv()</code> were changed to accomodate for the single touch protocol. <br/>
For the Kobo Aura (and others with the same kernel quirks) with multitouch support, an extra function <code>Input:handlePhoenixTouchEv()</code> was added.</p>

<p>Linux supports two kinds of Multi-touch protocols:</p>

<ul>
    <li><a href="http://www.kernel.org/doc/Documentation/input/multi-touch-protocol.txt">http://www.kernel.org/doc/Documentation/input/multi-touch-protocol.txt</a></li>
</ul>

<p>Currently, KOReader supports gesture detection of protocol B, so if your device sends out protocol A, you need to make a variant of function <code>Input:handleTouchEv()</code> (like <code>Input:handleTypeBTouchEv()</code> and <code>Input:handlePhoenixTouchEv()</code>) and simulate protocol B. <br/>
You are also welcome to send a PR that adds protocol A support to KOReader.</p>

<p>More information on Linux's input system:</p>

<ul>
    <li><a href="http://www.kernel.org/doc/Documentation/input/event-codes.txt">http://www.kernel.org/doc/Documentation/input/event-codes.txt</a></li>
    <li><a href="http://www.kernel.org/doc/Documentation/input/input.txt">http://www.kernel.org/doc/Documentation/input/input.txt</a></li>
</ul>



<!-- kate: indent-mode cstyle; indent-width 4; replace-tabs on; remove-trailing-spaces none; -->



</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2021-10-26 19:18:15 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
